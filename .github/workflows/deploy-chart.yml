name: Deploy Helm Chart

on:
  workflow_dispatch:
    inputs:
      imageRepo:
        description: "Docker image repository"
        required: false
        default: "990060748279.dkr.ecr.us-east-1.amazonaws.com/swapp-dev"
      imageTag:
        description: "Docker image tag"
        required: false
        default: "latest"
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # 1. Checkout repository
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------
      # 2. Install prerequisites
      # ----------------------------
      - name: Install CLI tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq unzip curl

      # ----------------------------
      # 3. Install AWS CLI v2
      # ----------------------------
      - name: Install AWS CLI v2
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update
          aws --version

      # ----------------------------
      # 4. Configure AWS credentials
      # ----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      # ----------------------------
      # 5. Verify AWS identity and EKS access
      # ----------------------------
      - name: Verify AWS identity and EKS cluster
        run: |
          echo "üîç Checking AWS Identity..."
          aws sts get-caller-identity
          
          echo "üîç Listing available EKS clusters..."
          aws eks list-clusters --region ap-south-1
          
          echo "üîç Describing cluster..."
          aws eks describe-cluster --name "${{ secrets.EKS_CLUSTER_NAME }}" --region ap-south-1 --query "cluster.status"

      # ----------------------------
      # 6. Configure kubectl access for EKS
      # ----------------------------
      - name: Configure kubectl for EKS
        run: |
          REGION="ap-south-1"
          CLUSTER_NAME="${{ secrets.EKS_CLUSTER_NAME }}"
          
          echo "üß© Setting up kubeconfig..."
          mkdir -p ~/.kube
          rm -f ~/.kube/config
          aws eks update-kubeconfig --region "$REGION" --name "$CLUSTER_NAME" --alias eks-github
          
          echo "‚úÖ kubeconfig configured successfully."
          echo "üîç Cluster info:"
          kubectl cluster-info
          echo "üîç Nodes:"
          kubectl get nodes || echo "‚ö†Ô∏è Unable to list nodes (check RBAC)."

      # ----------------------------
      # 7. Install Helm
      # ----------------------------
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.4"

      # ----------------------------
      # 8. Verify Kubernetes connectivity
      # ----------------------------
      - name: Verify Kubernetes connection
        run: |
          echo "üîç Current context:"
          kubectl config current-context
          
          echo "üîç Namespaces available:"
          kubectl get ns

      # ----------------------------
      # 9. Create namespaces (idempotent)
      # ----------------------------
      - name: Create namespaces
        run: |
          kubectl create namespace dev --dry-run=client -o yaml | kubectl apply -f -
          kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -

      # ----------------------------
      # 10. Deploy Helm Chart to DEV
      # ----------------------------
      - name: Deploy Helm Chart to Development
        if: github.ref == 'refs/heads/dev'
        run: |
          IMAGE_REPO="${{ github.event.inputs.imageRepo || '990060748279.dkr.ecr.us-east-1.amazonaws.com/swapp-dev' }}"
          IMAGE_TAG="${{ github.event.inputs.imageTag || 'latest' }}"
          
          echo "üöÄ Deploying to Development environment..."
          helm upgrade --install webapp ./helm-gitops-project/charts/webapp \
            --values ./helm-gitops-project/charts/webapp/values/dev.yaml \
            --set image.repository=$IMAGE_REPO \
            --set image.tag=$IMAGE_TAG \
            -n dev \
            --create-namespace
          
          echo "‚úÖ Development deployment completed successfully."

      # ----------------------------
      # 11. Deploy Helm Chart to PROD
      # ----------------------------
      - name: Deploy Helm Chart to Production
        if: github.ref == 'refs/heads/main'
        run: |
          IMAGE_REPO="${{ github.event.inputs.imageRepo || '990060748279.dkr.ecr.us-east-1.amazonaws.com/swapp-dev' }}"
          IMAGE_TAG="${{ github.event.inputs.imageTag || 'latest' }}"
          
          echo "üöÄ Deploying to Production environment..."
          helm upgrade --install webapp ./helm-gitops-project/charts/webapp \
            --values ./helm-gitops-project/charts/webapp/values/prod.yaml \
            --set image.repository=$IMAGE_REPO \
            --set image.tag=$IMAGE_TAG \
            -n production \
            --create-namespace
          
          echo "‚úÖ Production deployment completed successfully."
