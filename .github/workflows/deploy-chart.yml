name: ğŸ§© Helm Chart Deployment (Dev + Prod) â€” Zero Downtime

on:
  workflow_dispatch:
    inputs:
      imageRepo:
        description: "Docker image repository (ECR)"
        required: false
        default: "990060748279.dkr.ecr.us-east-1.amazonaws.com/swapp-dev"
      imageTag:
        description: "Docker image tag"
        required: false
        default: "latest"
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        env:
          - name: dev
            release: webapp-dev
            namespace: dev
            valuesFile: ./helm-gitops-project/charts/webapp/values/dev.yaml
          - name: prod
            release: webapp-prod
            namespace: production
            valuesFile: ./helm-gitops-project/charts/webapp/values/prod.yaml

    steps:
      # ğŸ§¾ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âš™ï¸ Setup Helm
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.13.0"

      # âš™ï¸ Setup kubectl
      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      # ğŸ” Configure kubeconfig using ServiceAccount Token
      - name: Configure kubeconfig
        env:
          K8S_SERVER: https://8E8E0B619BB89BD85A4298A1A6C979C3.gr7.ap-south-1.eks.amazonaws.com
          K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
        run: |
          mkdir -p ~/.kube
          cat <<EOF > ~/.kube/config
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              insecure-skip-tls-verify: true
              server: ${K8S_SERVER}
            name: eks-cluster
          contexts:
          - context:
              cluster: eks-cluster
              user: sa-user
            name: eks-context
          current-context: eks-context
          users:
          - name: sa-user
            user:
              token: ${K8S_TOKEN}
          EOF

      # ğŸ” Verify cluster access
      - name: Verify Cluster Access
        run: |
          echo "ğŸ” Checking cluster connectivity..."
          kubectl cluster-info
          kubectl get nodes -o wide

      # ğŸ—ï¸ Create namespace if not exists
      - name: Ensure Namespace Exists
        run: |
          kubectl create namespace ${{ matrix.env.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      # ğŸ§© Adopt existing Kubernetes resources (for zero downtime)
      - name: Adopt Existing Resources
        run: |
          echo "ğŸ”„ Adopting existing resources for ${{ matrix.env.release }}..."
          NS=${{ matrix.env.namespace }}
          RELEASE=${{ matrix.env.release }}
          for TYPE in deployment svc ingress configmap; do
            for NAME in $(kubectl get $TYPE -n $NS --no-headers -o custom-columns=":metadata.name" | grep $RELEASE || true); do
              echo "ğŸ”„ Adopting $TYPE $NAME ..."
              kubectl -n $NS annotate $TYPE $NAME meta.helm.sh/release-name=$RELEASE meta.helm.sh/release-namespace=$NS --overwrite
              kubectl -n $NS label $TYPE $NAME app.kubernetes.io/managed-by=Helm --overwrite
            done
          done

      # ğŸš€ Deploy Helm chart
      - name: Deploy Helm Chart â€” ${{ matrix.env.name }}
        working-directory: ./helm-gitops-project
        run: |
          echo "ğŸš€ Deploying ${{ matrix.env.release }} to namespace ${{ matrix.env.namespace }} ..."
          helm upgrade --install ${{ matrix.env.release }} ./charts/webapp \
            --values ${{ matrix.env.valuesFile }} \
            --set image.repository=${{ github.event.inputs.imageRepo }} \
            --set image.tag=${{ github.event.inputs.imageTag }} \
            -n ${{ matrix.env.namespace }} \
            --atomic --timeout 10m0s --wait

      # âœ… Post-deploy verification
      - name: Verify Deployment â€” ${{ matrix.env.name }}
        run: |
          NS=${{ matrix.env.namespace }}
          RELEASE=${{ matrix.env.release }}
          echo "ğŸ” Checking resources in namespace $NS ..."
          kubectl get all -n $NS | grep $RELEASE || true
          echo "âœ… Waiting for rollout..."
          kubectl rollout status deployment/${RELEASE} -n $NS --timeout=180s
          echo "ğŸŒ Ingress info:"
          kubectl get ingress -n $NS | grep $RELEASE || true
