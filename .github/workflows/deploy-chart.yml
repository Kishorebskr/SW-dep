name: ğŸ§© Helm Chart Deployment (Dev + Prod) â€” Zero Downtime

on:
  workflow_dispatch:
    inputs:
      imageRepo:
        description: "Docker image repository (ECR)"
        required: false
        default: "990060748279.dkr.ecr.us-east-1.amazonaws.com/swapp-dev"
      imageTag:
        description: "Docker image tag"
        required: false
        default: "latest"

  push:
    branches:
      - dev
      - main

env:
  K8S_SERVER: https://8E8E0B619BB89BD85A4298A1A6C979C3.gr7.ap-south-1.eks.amazonaws.com
  K8S_TOKEN: ${{ secrets.K8S_TOKEN }}

jobs:
  # --------------------------------------------------------
  # ğŸ§± Deploy to DEV environment when dev branch is pushed
  # --------------------------------------------------------
  deploy-dev:
    if: ${{ github.ref == 'refs/heads/dev' }}
    runs-on: ubuntu-22.04
    name: ğŸš€ Deploy to DEV

    steps:
      # ğŸ§¾ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âš™ï¸ Setup Helm
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.13.0"

      # âš™ï¸ Setup Kubectl
      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      # ğŸ” Configure kubeconfig
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          cat <<EOF > ~/.kube/config
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              insecure-skip-tls-verify: true
              server: ${K8S_SERVER}
            name: eks-cluster
          contexts:
          - context:
              cluster: eks-cluster
              user: sa-user
            name: eks-context
          current-context: eks-context
          users:
          - name: sa-user
            user:
              token: ${K8S_TOKEN}
          EOF

      # ğŸ” Verify cluster access
      - name: Verify Cluster Access
        run: |
          echo "ğŸ” Checking cluster connectivity..."
          kubectl cluster-info
          kubectl get nodes -o wide

      # ğŸ—ï¸ Ensure namespace exists
      - name: Ensure Namespace Exists
        run: |
          kubectl create namespace dev --dry-run=client -o yaml | kubectl apply -f -

      # ğŸ§© Adopt existing resources (for zero downtime)
      - name: Adopt Existing Resources
        run: |
          RELEASE=webapp-dev
          NS=dev
          for TYPE in deployment svc ingress configmap; do
            for NAME in $(kubectl get $TYPE -n $NS --no-headers -o custom-columns=":metadata.name" | grep $RELEASE || true); do
              echo "ğŸ”„ Adopting $TYPE $NAME ..."
              kubectl -n $NS annotate $TYPE $NAME meta.helm.sh/release-name=$RELEASE meta.helm.sh/release-namespace=$NS --overwrite
              kubectl -n $NS label $TYPE $NAME app.kubernetes.io/managed-by=Helm --overwrite
            done
          done

      # ğŸš€ Deploy Helm chart
      - name: Deploy Helm Chart â€” DEV
        working-directory: ./helm-gitops-project
        run: |
          echo "ğŸš€ Deploying webapp-dev to dev namespace ..."
          helm upgrade --install webapp-dev ./charts/webapp \
            --values charts/webapp/values/dev.yaml \
            --set image.repository=${{ github.event.inputs.imageRepo }} \
            --set image.tag=${{ github.event.inputs.imageTag }} \
            -n dev --atomic --timeout 10m0s --wait

      # âœ… Post-deploy verification
      - name: Verify Deployment â€” DEV
        run: |
          echo "ğŸ” Checking DEV resources ..."
          kubectl get all -n dev | grep webapp-dev || true
          kubectl rollout status deployment/webapp-dev -n dev --timeout=180s
          kubectl get ingress -n dev | grep webapp-dev || true

  # --------------------------------------------------------
  # ğŸ§± Deploy to PROD environment when main branch is pushed
  # --------------------------------------------------------
  deploy-prod:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-22.04
    name: ğŸš€ Deploy to PROD

    steps:
      # ğŸ§¾ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âš™ï¸ Setup Helm
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.13.0"

      # âš™ï¸ Setup Kubectl
      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      # ğŸ” Configure kubeconfig
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          cat <<EOF > ~/.kube/config
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              insecure-skip-tls-verify: true
              server: ${K8S_SERVER}
            name: eks-cluster
          contexts:
          - context:
              cluster: eks-cluster
              user: sa-user
            name: eks-context
          current-context: eks-context
          users:
          - name: sa-user
            user:
              token: ${K8S_TOKEN}
          EOF

      # ğŸ” Verify cluster access
      - name: Verify Cluster Access
        run: |
          echo "ğŸ” Checking cluster connectivity..."
          kubectl cluster-info
          kubectl get nodes -o wide

      # ğŸ—ï¸ Ensure namespace exists
      - name: Ensure Namespace Exists
        run: |
          kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -

      # ğŸ§© Adopt existing resources
      - name: Adopt Existing Resources
        run: |
          RELEASE=webapp-prod
          NS=production
          for TYPE in deployment svc ingress configmap; do
            for NAME in $(kubectl get $TYPE -n $NS --no-headers -o custom-columns=":metadata.name" | grep $RELEASE || true); do
              echo "ğŸ”„ Adopting $TYPE $NAME ..."
              kubectl -n $NS annotate $TYPE $NAME meta.helm.sh/release-name=$RELEASE meta.helm.sh/release-namespace=$NS --overwrite
              kubectl -n $NS label $TYPE $NAME app.kubernetes.io/managed-by=Helm --overwrite
            done
          done

      # ğŸš€ Deploy Helm chart
      - name: Deploy Helm Chart â€” PROD
        working-directory: ./helm-gitops-project
        run: |
          echo "ğŸš€ Deploying webapp-prod to production namespace ..."
          helm upgrade --install webapp-prod ./charts/webapp \
            --values charts/webapp/values/prod.yaml \
            --set image.repository=${{ github.event.inputs.imageRepo }} \
            --set image.tag=${{ github.event.inputs.imageTag }} \
            -n production --atomic --timeout 10m0s --wait

      # âœ… Post-deploy verification
      - name: Verify Deployment â€” PROD
        run: |
          echo "ğŸ” Checking PROD resources ..."
          kubectl get all -n production | grep webapp-prod || true
          kubectl rollout status deployment/webapp-prod -n production --timeout=180s
          kubectl get ingress -n production | grep webapp-prod || true
